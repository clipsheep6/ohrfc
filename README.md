# OHRFC：工业级设计规范工作流

## 概述

OHRFC 是一个 Claude Code Skill，将模糊需求转化为**可验证的设计规范** (`rfc.md`)。

核心输出物不是代码，而是一份结构化的约束集合——边界规则 (HR)、决策记录 (DEC)、可证伪的验收场景 (SCN) 和证据链 (EVD)。适用于 OS/平台/框架级服务设计、API 契约定义、跨模块架构决策。

本项目分两层：

- **方法论**（不变量）——定义设计规范应满足的性质，不绑定特定工具链或阶段划分
- **工作流**（当前实现）——方法论的一种具体落地，可以有不同实现

触发：`/ohrfc` 或自然语言（"create RFC"、"design spec"、"需求分析"等）。

---

## 方法论

所有原则围绕一个核心：**把人的注意力引导到最重要的地方**。设计过程中人的判断力是最稀缺的资源——方法论的每一层都在减少噪音、提升信噪比，让人只在关键决策点介入。

具体执行规则见 `SKILL.md`。

### 一、设计建模——把问题结构化

> 目标：让"模糊需求"变成"可操作的约束集"，为后续所有环节提供共同语言。

**设计 = 确认约束集 → 收窄解空间 → 澄清取舍 → 可验证验收**

**约束优先**。先摆约束，再做 取舍：

- 先确认所有约束（安全红线、资源上限、兼容性承诺）→ 约束淘汰不可行方案 → 在可行域内选择 → 记录选择理由
- rfc.md 的核心不是"方案描述"，而是"约束集合 + 在约束下的选择理由"

**唯一真相**。`rfc.md` 是唯一权威文档（SSOT）。所有结论必须回写为带 ID 的条目，不在 rfc.md 中的结论不具有规范效力。消除"纪要说 A、文档写 B、代码做 C"的漂移。

**ID 锚定**。每条内容有全局唯一 ID，确保可追踪、可交叉引用、Gate 可自动扫描：

| ID | 用途 | 示例 |
|----|------|------|
| HR-### | 硬规则 / 红线 | SEC-HR-001: 未授权请求必须拒绝且无副作用 |
| DEC-### | 决策与 取舍 | DEC-003: 选 B，延迟更低（牺牲内存） |
| REQ-### | 需求与约束 | REQ-002: 本期不支持集群部署 |
| SCN-### | 验收场景 | SCN-005: WHEN 请求超限 THEN 返回 429 |
| CHG-### | 基线后变更 | CHG-001: 修改 §7 认证策略 |
| EVD-### | 证据 | EVD-002: kernel/sched.c:142, rev=abc123 |

**证据驱动**。硬断言必须有可验证的证据（代码位置 + 版本，或外部文档 + 日期），不是"我记得"。无法验证的标记为 Unresolved，由 Gate 拦截。

### 二、高效收敛——用好每一次提问

> 目标：让约束集快速收敛，不在低价值问题上消耗用户注意力。

**分层提问**。不是所有问题都值得问。按影响面分级，把提问预算留给真正改变解空间的问题：

| 级别 | 性质 | 处理 |
|------|------|------|
| Tier 1 | 约束冲突——代码与需求矛盾、安全边界越权 | **必须问**，答案改变整个解空间 |
| Tier 2 | 方向分叉——≥2 条路径各有 取舍 | **必须问**，答案决定设计方向 |
| Tier 3 | 边界澄清——范围模糊、默认行为不明确 | 配额允许时问 |
| Tier 4 | 可自答——重新扫描代码即可解决 | **不问**，转为证据采集 |

同级内按影响 ID 数降序；每轮最多 4 个问题；Tier 4 在呈现前过滤。

**有界收敛**。所有循环都有退出边界：

- 机械修复回环通常 1-2 轮自动收敛
- 语义评审回环有严格度决定的轮次上限
- 第 2 轮失败即触发 Early Breaker，提前给用户选择权
- 超限时强制三选一：缩小范围 / 风险接受（DEC 记录残余风险 + 负责人）/ 升级
- P0 风险永不接受

### 三、质量保底——机器先过滤，人再判断

> 目标：不让人浪费注意力在机械性错误上；到人手里的规范已经结构完整、证据齐全。

**双质量门**。设计完成后经过两道门：

- **Gate-A（机械）**：结构完整性、ID 唯一性、无占位符、SCN 覆盖率、证据交叉验证。脚本自动执行，HARD 项失败即打回——这些问题不需要人看
- **Gate-B（语义）**：多角色并行评审，检查约束充分性、取舍 合理性、场景完整性。6 条 PASS 谓词全部满足才通过

Gate-A 必须先于 Gate-B——机械正确是语义评审的前提。

**可证伪验收**。验收场景 (SCN) 采用 EARS 格式（WHEN/AND/THEN），必须能判定"过"或"不过"——不是"看起来没问题"。最低覆盖 5 个类别：`normal` · `reject` · `limits_quota` · `dependency_down` · `abuse`。每个新机制、新分支、新失败路径都必须绑定 ≥1 条 SCN。

### 四、Review 聚焦——让人只看最重要的事

> 目标：人工审批时，关键决策、核心风险、必过场景一眼可见，不需要通读全文。

**结构化呈现**。Review 前先生成 RFC 摘要——标题/范围、TL;DR（3-6 点）、关键 DEC 决策、顶级 HR 约束、must-pass SCN、已接受的风险。审批者看摘要就能抓到方案骨架。

**风险优先排序**。Progressive Review 模式用思维模型对各节做风险预分析，把高风险区域前置呈现。审批者的注意力先落在最可能出问题的地方，而不是按章节顺序线性阅读。

**概念正交**。方法论的核心维度（阶段、严格度、制品层、ID 体系、Gate 语义）彼此正交，不混淆替代。新增概念前先检查能否归入已有维度。这降低了审批者的认知负担——理解 5 个独立维度，比理解 5 个纠缠在一起的概念容易得多。

---

## 使用

### 严格度

| 维度 | Light | Standard（默认） | Full |
|------|-------|----------|------|
| 目标 | 低风险快速通过 | 质量/效率平衡 | 保守、降低不确定性 |
| Gate-B | 跳过 | 1 路自审（可升级→3 路并行） | 3+1 路多模型并行 |
| 证据要求 | 仅硬断言 | 硬断言 + 关键决策 | 全部；缺口必须标记 |
| SCN 覆盖矩阵 | 可选 | 推荐 | 强制 |

Light/Full 需用户明确指定，默认 Standard。

### 交互模式

触发后自动检测已有工作区并路由：新建 RFC / 变更已有 RFC（基线后轻量变更协议）/ 继续未完成 RFC（checkpoint 恢复）。

---

## 流程速览（当前实现）

> 以下是方法论的一种实现。阶段划分和工具选型可替换，方法论约束不变。

```
INIT → DISCOVER & CLARIFY → DESIGN → GATE-A → GATE-B → REVIEW → FINALIZE
       扫描+提问+证据       约束→方案  机械检查  语义评审  人工审批  锁定+导出
```

Gate 失败有界回环；Light 模式跳过 Gate-B。细节见 `SKILL.md`。

---

## 产出物

工作区：`.ohrfc/<rfc_id>/`

| 文件 | 说明 |
|------|------|
| `rfc.md` | 唯一规范文档——约束、决策、场景、变更记录 |
| `evidence.json` | 证据链（代码位置、外部来源、置信度） |
| `state.json` | 工作流状态（当前阶段、严格度、Gate 结果） |
| `checkpoint.md` | 阶段边界推理快照（用于上下文恢复） |

---

## 项目结构

```
ohrfc/
├── SKILL.md                     # 完整执行协议
├── references/
│   ├── methodology.md           # 核心方法论
│   ├── phase_*.md               # 各阶段执行协议（7 个）
│   ├── rfc_template.md          # rfc.md 骨架模板
│   ├── checkpoint_protocol.md   # 检查点与恢复协议
│   ├── *_assets.md              # 阶段辅助模板
│   └── reviewer_prompts/        # Gate-B 角色提示词
├── scripts/
│   ├── ohrfc_init.py            # INIT 自动化
│   └── gate_a_check.py          # Gate-A 机械检查脚本
└── assets/
    ├── schemas/                 # JSON Schema
    └── examples/                # 示例文件
```
